<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>AR射击小游戏</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
                color: white;
                overflow: hidden;
                height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .container {
                width: 100%;
                max-width: 800px;
                text-align: center;
                padding: 20px;
            }

            h1 {
                font-size: 2.5rem;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }

            .subtitle {
                font-size: 1.2rem;
                margin-bottom: 30px;
                opacity: 0.9;
            }

            .game-area {
                position: relative;
                width: 100%;
                height: 60vh;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
                margin-bottom: 20px;
            }

            #video {
                width: 100%;
                height: 100%;
                object-fit: cover;
                background-color: #000;
            }

            #canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
            }

            .target {
                position: absolute;
                width: 80px;
                height: 80px;
                background: radial-gradient(circle, #ff3333 0%, #990000 70%);
                border-radius: 50%;
                border: 4px solid #ffcc00;
                box-shadow: 0 0 20px rgba(255, 50, 50, 0.7);
                transition: transform 0.2s;
                z-index: 20;
            }

            .target.hit {
                animation: hitAnimation 0.5s;
            }

            @keyframes hitAnimation {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.3);
                }
                100% {
                    transform: scale(1);
                }
            }

            .energy-ball {
                position: absolute;
                width: 20px;
                height: 20px;
                background: radial-gradient(circle, #00ffff 0%, #0088ff 70%);
                border-radius: 50%;
                box-shadow: 0 0 15px rgba(0, 200, 255, 0.9);
                z-index: 15;
                pointer-events: none;
            }

            .controls {
                display: flex;
                justify-content: space-between;
                width: 100%;
                margin-top: 20px;
            }

            .score-board {
                background: rgba(0, 0, 0, 0.6);
                padding: 15px 25px;
                border-radius: 10px;
                font-size: 1.5rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            button {
                background: linear-gradient(to right, #ff8a00, #da1b60);
                color: white;
                border: none;
                padding: 15px 30px;
                font-size: 1.1rem;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                transition: all 0.3s;
            }

            button:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            }

            button:active {
                transform: translateY(1px);
            }

            .instructions {
                background: rgba(0, 0, 0, 0.6);
                padding: 15px;
                border-radius: 10px;
                margin-top: 20px;
                font-size: 1rem;
                line-height: 1.5;
            }

            .hit-effect {
                position: absolute;
                width: 100px;
                height: 100px;
                background: radial-gradient(
                    circle,
                    rgba(255, 255, 255, 0.8) 0%,
                    rgba(255, 255, 255, 0) 70%
                );
                border-radius: 50%;
                pointer-events: none;
                z-index: 25;
                animation: hitEffect 0.5s forwards;
            }

            @keyframes hitEffect {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                100% {
                    transform: scale(2);
                    opacity: 0;
                }
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 2rem;
                }

                .game-area {
                    height: 50vh;
                }

                .target {
                    width: 60px;
                    height: 60px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>AR射击小游戏</h1>
            <p class="subtitle">瞄准靶子，点击屏幕发射能量球！</p>

            <div class="game-area">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <!-- 靶子将通过JS动态生成 -->
            </div>

            <div class="controls">
                <div class="score-board">得分: <span id="score">0</span></div>
                <button id="start-btn">开始游戏</button>
            </div>

            <div class="instructions">
                <p>
                    游戏说明：允许摄像头权限后，靶子会随机出现在屏幕上。点击屏幕任意位置发射能量球击中靶子得分。
                </p>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const video = document.getElementById('video')
                const canvas = document.getElementById('canvas')
                const startBtn = document.getElementById('start-btn')
                const scoreDisplay = document.getElementById('score')
                const gameArea = document.querySelector('.game-area')

                let score = 0
                let target = null
                let gameActive = false
                let animationFrameId = null

                // 初始化摄像头
                async function initCamera() {
                    try {
                        const stream =
                            await navigator.mediaDevices.getUserMedia({
                                video: {
                                    facingMode: 'environment',
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 },
                                },
                            })
                        video.srcObject = stream

                        // 等待视频加载
                        video.addEventListener('loadedmetadata', function () {
                            canvas.width = video.videoWidth
                            canvas.height = video.videoHeight
                        })

                        return true
                    } catch (err) {
                        console.error('摄像头访问错误:', err)
                        alert(
                            '无法访问摄像头，请确保已授予摄像头权限并刷新页面重试。'
                        )
                        return false
                    }
                }

                // 创建靶子
                function createTarget() {
                    // 移除现有靶子
                    if (target) {
                        target.remove()
                    }

                    // 创建新靶子
                    target = document.createElement('div')
                    target.className = 'target'

                    // 随机位置 (确保在可视区域内)
                    const maxX = gameArea.offsetWidth - 80
                    const maxY = gameArea.offsetHeight - 80

                    const posX = Math.floor(Math.random() * maxX)
                    const posY = Math.floor(Math.random() * maxY)

                    target.style.left = `${posX}px`
                    target.style.top = `${posY}px`

                    gameArea.appendChild(target)

                    // 添加点击事件监听器
                    target.addEventListener('click', handleTargetHit)
                }

                // 处理靶子被击中
                function handleTargetHit(e) {
                    if (!gameActive) return

                    // 创建击中效果
                    const hitEffect = document.createElement('div')
                    hitEffect.className = 'hit-effect'
                    hitEffect.style.left = `${
                        e.clientX - gameArea.getBoundingClientRect().left - 50
                    }px`
                    hitEffect.style.top = `${
                        e.clientY - gameArea.getBoundingClientRect().top - 50
                    }px`
                    gameArea.appendChild(hitEffect)

                    // 移除效果元素
                    setTimeout(() => {
                        hitEffect.remove()
                    }, 500)

                    // 更新分数
                    score += 10
                    scoreDisplay.textContent = score

                    // 靶子击中动画
                    target.classList.add('hit')
                    setTimeout(() => {
                        target.classList.remove('hit')
                        createTarget()
                    }, 500)
                }

                // 发射能量球
                function shootEnergyBall(x, y) {
                    if (!gameActive) return

                    const energyBall = document.createElement('div')
                    energyBall.className = 'energy-ball'

                    // 从屏幕底部中心发射
                    const startX = gameArea.offsetWidth / 2
                    const startY = gameArea.offsetHeight

                    energyBall.style.left = `${startX}px`
                    energyBall.style.top = `${startY}px`

                    gameArea.appendChild(energyBall)

                    // 动画移动到点击位置
                    const targetX = x - gameArea.getBoundingClientRect().left
                    const targetY = y - gameArea.getBoundingClientRect().top

                    const dx = targetX - startX
                    const dy = targetY - startY
                    const distance = Math.sqrt(dx * dx + dy * dy)
                    const duration = Math.min(distance / 5, 1000) // 限制最大动画时间

                    energyBall.style.transition = `all ${duration}ms linear`

                    // 触发重排以应用初始状态
                    energyBall.offsetHeight

                    // 移动到目标位置
                    energyBall.style.left = `${targetX}px`
                    energyBall.style.top = `${targetY}px`

                    // 动画结束后移除能量球
                    setTimeout(() => {
                        energyBall.remove()
                    }, duration)
                }

                // 处理屏幕点击
                gameArea.addEventListener('click', function (e) {
                    if (!gameActive) return

                    // 发射能量球
                    shootEnergyBall(e.clientX, e.clientY)
                })

                // 开始游戏
                startBtn.addEventListener('click', async function () {
                    if (gameActive) {
                        // 重置游戏
                        gameActive = false
                        cancelAnimationFrame(animationFrameId)
                        startBtn.textContent = '开始游戏'
                        score = 0
                        scoreDisplay.textContent = score
                        if (target) target.remove()
                    } else {
                        // 开始新游戏
                        const cameraReady = await initCamera()
                        if (cameraReady) {
                            gameActive = true
                            startBtn.textContent = '重新开始'
                            createTarget()
                        }
                    }
                })

                // 初始状态显示提示
                startBtn.textContent = '开始游戏'
            })
        </script>
    </body>
</html>
